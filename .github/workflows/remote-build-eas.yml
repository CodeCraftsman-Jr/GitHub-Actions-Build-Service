name: Remote Build (EAS-Compatible)

on:
  repository_dispatch:
    types: [remote-build]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Parse build configuration
        id: build_info
        run: |
          echo "SOURCE_URL=${{ github.event.client_payload.source_url }}" >> $GITHUB_OUTPUT
          echo "BUILD_ID=${{ github.event.client_payload.build_id }}" >> $GITHUB_OUTPUT
          echo "PLATFORM=${{ github.event.client_payload.platform }}" >> $GITHUB_OUTPUT
          echo "VARIANT=${{ github.event.client_payload.variant || 'release' }}" >> $GITHUB_OUTPUT
          echo "BUILD_TYPE=${{ github.event.client_payload.build_type || 'apk' }}" >> $GITHUB_OUTPUT
          echo "GRADLE_COMMAND=${{ github.event.client_payload.gradle_command || 'assembleRelease' }}" >> $GITHUB_OUTPUT
          echo "AUTO_INCREMENT=${{ github.event.client_payload.auto_increment || 'false' }}" >> $GITHUB_OUTPUT

      - name: Display build configuration
        run: |
          echo "ðŸ—ï¸  Build Configuration:"
          echo "  Build ID: ${{ steps.build_info.outputs.BUILD_ID }}"
          echo "  Platform: ${{ steps.build_info.outputs.PLATFORM }}"
          echo "  Variant: ${{ steps.build_info.outputs.VARIANT }}"
          echo "  Build Type: ${{ steps.build_info.outputs.BUILD_TYPE }}"
          echo "  Gradle Command: ${{ steps.build_info.outputs.GRADLE_COMMAND }}"
          echo "  Auto Increment: ${{ steps.build_info.outputs.AUTO_INCREMENT }}"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download source code
        env:
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
        run: |
          curl -L -o source.tar.gz \
            -H "X-Appwrite-Project: ${{ secrets.APPWRITE_PROJECT_ID }}" \
            -H "X-Appwrite-Key: $APPWRITE_API_KEY" \
            "${{ steps.build_info.outputs.SOURCE_URL }}"
          
          mkdir -p project
          tar -xzf source.tar.gz -C project
          ls -la project/

      - name: Install dependencies
        working-directory: project
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile
          else
            npm install
          fi

      - name: Set environment variables from EAS profile
        working-directory: project
        run: |
          # Extract environment variables from client_payload
          ENV_VARS='${{ toJson(github.event.client_payload.env) }}'
          
          if [ "$ENV_VARS" != "null" ] && [ "$ENV_VARS" != "" ]; then
            echo "ðŸ”§ Setting environment variables from EAS profile..."
            echo "$ENV_VARS" | jq -r 'to_entries[] | "\(.key)=\(.value)"' >> $GITHUB_ENV
          fi

      - name: Auto-increment version code
        if: steps.build_info.outputs.AUTO_INCREMENT == 'true'
        working-directory: project
        run: |
          echo "ðŸ”¢ Auto-incrementing version code..."
          
          # For Expo projects, increment versionCode in app.json
          if [ -f "app.json" ]; then
            VERSION_CODE=$(jq '.expo.android.versionCode' app.json)
            NEW_VERSION_CODE=$((VERSION_CODE + 1))
            jq ".expo.android.versionCode = $NEW_VERSION_CODE" app.json > app.json.tmp
            mv app.json.tmp app.json
            echo "âœ… Version code incremented: $VERSION_CODE â†’ $NEW_VERSION_CODE"
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Expo prebuild
        working-directory: project
        run: npx expo prebuild --platform android --clean

      - name: Build Android
        working-directory: project/android
        run: |
          echo "ðŸ”¨ Running gradle command: ${{ steps.build_info.outputs.GRADLE_COMMAND }}"
          ./gradlew ${{ steps.build_info.outputs.GRADLE_COMMAND }} --no-daemon
          
          # Find the output file
          if [ "${{ steps.build_info.outputs.BUILD_TYPE }}" == "aab" ]; then
            OUTPUT_FILE=$(find app/build/outputs/bundle -name "*.aab" | head -n 1)
            EXTENSION="aab"
          else
            OUTPUT_FILE=$(find app/build/outputs/apk -name "*.apk" | head -n 1)
            EXTENSION="apk"
          fi
          
          echo "OUTPUT_FILE=$OUTPUT_FILE" >> $GITHUB_ENV
          echo "EXTENSION=$EXTENSION" >> $GITHUB_ENV
          
          echo "âœ… Build complete: $OUTPUT_FILE"

      - name: Rename output file
        working-directory: project/android
        run: |
          TIMESTAMP=$(date +%s)
          OUTPUT_NAME="build-${{ steps.build_info.outputs.BUILD_ID }}-${TIMESTAMP}-${{ steps.build_info.outputs.VARIANT }}.${{ env.EXTENSION }}"
          cp "$OUTPUT_FILE" "$OUTPUT_NAME"
          echo "FINAL_OUTPUT=$OUTPUT_NAME" >> $GITHUB_ENV
          echo "ðŸ“¦ Output file: $OUTPUT_NAME"

      - name: Upload to Appwrite Storage
        working-directory: project/android
        env:
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
        run: |
          UPLOAD_RESPONSE=$(curl -X POST \
            "${{ secrets.APPWRITE_ENDPOINT }}/storage/buckets/${{ secrets.APPWRITE_BUCKET }}/files" \
            -H "X-Appwrite-Project: ${{ secrets.APPWRITE_PROJECT_ID }}" \
            -H "X-Appwrite-Key: $APPWRITE_API_KEY" \
            -H "Content-Type: multipart/form-data" \
            -F "fileId=unique()" \
            -F "file=@${{ env.FINAL_OUTPUT }}")
          
          echo "âœ… Uploaded to Appwrite Storage"
          echo "$UPLOAD_RESPONSE" | jq '.'

      - name: Upload artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FINAL_OUTPUT }}
          path: project/android/${{ env.FINAL_OUTPUT }}
          retention-days: 30

      - name: Build summary
        if: always()
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${{ steps.build_info.outputs.BUILD_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile**: ${{ steps.build_info.outputs.VARIANT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Gradle Command**: ${{ steps.build_info.outputs.GRADLE_COMMAND }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Output Type**: ${{ steps.build_info.outputs.BUILD_TYPE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Build completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **Output**: \`${{ env.FINAL_OUTPUT }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi
